# Test: Multi-deployment with hooks inheriting ServiceAccount
# Tests deployment-level hooks with:
# - Hook inheriting existing SA from deployment (serviceAccount.create=false, name=xxx)
# - Hook with explicit serviceAccountName override
# - Inheritance of tolerations, affinity, envFrom

deployments:
  odoo:
    enabled: true
    podRecreation:
      enabled: true
    autoscaling:
      enabled: false
      minReplicas: 2
      maxReplicas: 6
      targetMemoryUtilizationPercentage: 90
      behavior:
        scaleUp:
          stabilizationWindowSeconds: 60
          policies:
            - type: Percent
              value: 100
              periodSeconds: 60
          selectPolicy: Max
        scaleDown:
          stabilizationWindowSeconds: 300
          policies:
            - type: Percent
              value: 30
              periodSeconds: 60
          selectPolicy: Min
    resources:
      requests:
        cpu: 10m
        memory: 1024Mi
    replicaCount: 1
    image:
      repository: nginx
      tag: latest
      pullPolicy: Always
    service:
      port: 8069
      targetPort: 8069
      portName: odoo
    additionalPorts:
      - name: gevent
        port: 8072
        targetPort: 8072
    configMap:
      HOST: "192.168.1.100"
      PORT: "5432"
      USER: "test_user"
      DB_NAME: "test_db"
      DBFILTER: "^test_db$"
    secret:
      PASSWORD: "fake-password-for-testing"
    readinessProbe:
      httpGet:
        path: /web/health
        port: 8069
      initialDelaySeconds: 20
      periodSeconds: 10
      timeoutSeconds: 5
      failureThreshold: 6
      successThreshold: 1
    livenessProbe:
      httpGet:
        path: /web/health
        port: 8069
      initialDelaySeconds: 60
      periodSeconds: 30
      timeoutSeconds: 5
      failureThreshold: 3
      successThreshold: 1
    tolerations:
      - key: "application"
        operator: "Equal"
        value: "true"
        effect: "NoSchedule"
    affinity:
      nodeAffinity:
        requiredDuringSchedulingIgnoredDuringExecution:
          nodeSelectorTerms:
            - matchExpressions:
                - key: cloud.google.com/gke-nodepool
                  operator: In
                  values:
                    - "application"
      podAntiAffinity:
        preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                  - key: app.kubernetes.io/instance
                    operator: In
                    values: ["odoo-stage"]
                  - key: app.kubernetes.io/name
                    operator: In
                    values: ["global-chart"]
              topologyKey: kubernetes.io/hostname
    mountedConfigFiles:
      files:
        - name: odoo-config
          filename: odoo.conf
          mountPath: /etc/odoo
          targetPath: /etc/odoo/odoo.conf
          content: |
            [options]
            addons_path = /mnt/extra-addons
            proxy_mode = True
            list_db = False
            db_name = odoo_stage
            admin_passwd = fake-admin-password
            data_dir = /var/lib/odoo
            server_wide_modules = web
            log_level = info
            max_cron_threads = 1
            workers = 2
            limit_time_cpu = 120
            limit_time_real = 240
            limit_memory_soft = 2147483648
            limit_memory_hard = 3221225472
            gevent_port = 8072
            [fs_storage.gcp_odoo_stage_attachment]
            protocol = gcs
            directory_path = odoo_stage_attachment
            options = {"token": "cloud", "project": "dbm-international", "cache_timeout": 0}
    serviceAccount:
      create: false
      name: "odoo-stage-workload-identity"
    hooks:
      pre-upgrade:
        scale-down:
          weight: 1
          image:
            repository: bitnami/kubectl
            tag: latest
          serviceAccountName: "odoo-scale-hooks"
          resources:
            requests:
              memory: 64Mi
              cpu: 50m
          command:
            - kubectl
            - scale
            - deployment
            - odoo-global-chart-odoo
            - --replicas=0
          args: []
        migration:
          weight: 2
          image:
            repository: nginx
            tag: latest
          imagePullPolicy: Always
          resources:
            requests:
              memory: 512Mi
              cpu: 500m
          command:
            - /bin/sh
            - -c
          args:
            - |
              echo "Running migration..." && \
              echo "DB_HOST=192.168.1.100" && \
              echo "DB_PORT=5432" && \
              echo "DB_USER=test_user" && \
              echo "DB_PASSWORD=fake-password" && \
              echo "Migration completed"

  nginx:
    enabled: true
    replicaCount: 1
    resources:
      requests:
        cpu: 50m
        memory: 64Mi
    podRecreation:
      enabled: true
    autoscaling:
      enabled: false
      minReplicas: 2
      maxReplicas: 6
      targetCPUUtilizationPercentage: 60
      behavior:
        scaleUp:
          stabilizationWindowSeconds: 0
          policies:
            - type: Percent
              value: 200
              periodSeconds: 60
          selectPolicy: Max
        scaleDown:
          stabilizationWindowSeconds: 120
          policies:
            - type: Percent
              value: 50
              periodSeconds: 60
          selectPolicy: Max
    image:
      repository: nginx
      tag: alpine
      pullPolicy: IfNotPresent
    service:
      port: 80
      targetPort: 80
      portName: http
    startupProbe:
      httpGet:
        path: /nginx-health
        port: 80
        httpHeaders:
          - name: Host
            value: stage.odoo.errediweb.com
      periodSeconds: 10
      failureThreshold: 70
      timeoutSeconds: 3
    readinessProbe:
      httpGet:
        path: /nginx-health
        port: 80
        httpHeaders:
          - name: Host
            value: stage.odoo.errediweb.com
      periodSeconds: 10
      failureThreshold: 3
      timeoutSeconds: 3
    livenessProbe:
      httpGet:
        path: /nginx-health
        port: 80
        httpHeaders:
          - name: Host
            value: stage.odoo.errediweb.com
      periodSeconds: 20
      failureThreshold: 5
      timeoutSeconds: 3
    tolerations:
      - key: "application"
        operator: "Equal"
        value: "true"
        effect: "NoSchedule"
    affinity:
      nodeAffinity:
        requiredDuringSchedulingIgnoredDuringExecution:
          nodeSelectorTerms:
            - matchExpressions:
                - key: cloud.google.com/gke-nodepool
                  operator: In
                  values:
                    - "application"
      podAntiAffinity:
        preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                  - key: app.kubernetes.io/instance
                    operator: In
                    values: ["odoo-stage"]
                  - key: app.kubernetes.io/name
                    operator: In
                    values: ["global-chart"]
              topologyKey: kubernetes.io/hostname
    mountedConfigFiles:
      files:
        - name: odoo-nginx-config
          filename: odoo.conf
          mountPath: /etc/nginx/conf.d
          targetPath: /etc/nginx/conf.d/odoo.conf
          content: |
            # Upstream Odoo
            upstream odoo {
              server odoo-global-chart-odoo:8069;
            }

            upstream odoochat {
              server odoo-global-chart-odoo:8072;
            }

            # WebSocket upgrade map
            map $http_upgrade $connection_upgrade {
              default upgrade;
              ''      close;
            }

            server {
              listen       80;
              server_name  stage.odoo.errediweb.com;

              # --- Real client IP from Cloudflare ---
              real_ip_header CF-Connecting-IP;
              real_ip_recursive on;

              # Cloudflare IPv4 ranges
              set_real_ip_from 173.245.48.0/20;
              set_real_ip_from 103.21.244.0/22;
              set_real_ip_from 103.22.200.0/22;
              set_real_ip_from 103.31.4.0/22;
              set_real_ip_from 141.101.64.0/18;
              set_real_ip_from 108.162.192.0/18;
              set_real_ip_from 190.93.240.0/20;
              set_real_ip_from 188.114.96.0/20;
              set_real_ip_from 197.234.240.0/22;
              set_real_ip_from 198.41.128.0/17;
              set_real_ip_from 162.158.0.0/15;
              set_real_ip_from 104.16.0.0/13;
              set_real_ip_from 104.24.0.0/14;
              set_real_ip_from 172.64.0.0/13;
              set_real_ip_from 131.0.72.0/22;

              # Cloudflare IPv6 ranges
              set_real_ip_from 2400:cb00::/32;
              set_real_ip_from 2606:4700::/32;
              set_real_ip_from 2803:f800::/32;
              set_real_ip_from 2405:b500::/32;
              set_real_ip_from 2405:8100::/32;
              set_real_ip_from 2a06:98c0::/29;
              set_real_ip_from 2c0f:f248::/32;

              # Limite upload (client)
              client_max_body_size 100m;

              # Timeout proxy
              proxy_read_timeout   720s;
              proxy_connect_timeout 720s;
              proxy_send_timeout   720s;

              # --- Gestione pagina di manutenzione quando Odoo è down ---
              proxy_intercept_errors on;
              error_page 502 503 504 /odoo-maintenance.html;

              # WebSocket per chat
              location /websocket {
                proxy_pass http://odoochat;
                proxy_set_header Host              $host;
                proxy_set_header X-Forwarded-Host  $http_host;
                proxy_set_header X-Forwarded-Proto $scheme;
                proxy_set_header X-Real-IP         $remote_addr;
                proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
                proxy_set_header Upgrade           $http_upgrade;
                proxy_set_header Connection        $connection_upgrade;
                proxy_buffering off;
              }

              # Backend Odoo
              location / {
                proxy_pass         http://odoo;
                proxy_set_header   Host              $host;
                proxy_set_header   X-Forwarded-Host  $http_host;
                proxy_set_header   X-Forwarded-Proto $http_x_forwarded_proto;
                proxy_set_header   X-Forwarded-Port  $http_x_forwarded_port;
                proxy_set_header   X-Real-IP         $remote_addr;
                proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
                proxy_buffering    off;
                proxy_redirect     http:// https://;
              }

              # Pagina di manutenzione (statica, usata in caso di errore upstream)
              location = /odoo-maintenance.html {
                root     /usr/share/nginx/html;
                internal;
              }

              # Health check di Nginx (non proxato)
              location = /nginx-health {
                add_header Content-Type text/plain;
                return 200 "ok\n";
              }

              # Gzip per asset statici
              gzip on;
              gzip_types text/css application/javascript application/json;
            }

        - name: odoo-maintenance-page
          filename: odoo-maintenance.html
          mountPath: /usr/share/nginx/html
          targetPath: /usr/share/nginx/html/odoo-maintenance.html
          content: |
            <!DOCTYPE html>
            <html lang="it">
            <head>
              <meta charset="UTF-8" />
              <meta name="viewport" content="width=device-width, initial-scale=1.0" />
              <title>Manutenzione in corso</title>
              <style>
                body {
                  margin: 0;
                  padding: 0;
                  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
                  background-color: #f5f5f5;
                  color: #333333;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  min-height: 100vh;
                }
                .container {
                  text-align: center;
                  padding: 24px;
                }
                h1 {
                  font-size: 28px;
                  margin-bottom: 16px;
                }
                p {
                  font-size: 16px;
                  margin: 6px 0;
                }
                .box {
                  background-color: #ffffff;
                  border-radius: 8px;
                  padding: 24px 28px;
                  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
                  max-width: 480px;
                }
                .status {
                  display: inline-block;
                  margin-top: 16px;
                  padding: 6px 12px;
                  border-radius: 999px;
                  font-size: 13px;
                  background-color: #ffe9b3;
                  color: #7a4a00;
                }
              </style>
            </head>
            <body>
              <div class="container">
                <div class="box">
                  <h1>Sistema in manutenzione</h1>
                  <p>Il servizio Odoo non è temporaneamente disponibile.</p>
                  <p>Stiamo effettuando attività di manutenzione o il sistema si sta riavviando.</p>
                  <p>Ti invitiamo a riprovare tra qualche minuto.</p>
                  <div class="status">
                    Stato: manutenzione temporanea
                  </div>
                </div>
              </div>
            </body>
            </html>

ingress:
  enabled: false

rbacs:
  roles:
    - name: odoo-scale-hooks
      serviceAccount:
        name: odoo-scale-hooks
        automount: true
      rules:
        - apiGroups: ["apps"]
          resources:
            - "deployments"
            - "deployments/scale"
          verbs:
            - "get"
            - "list"
            - "watch"
            - "update"
            - "patch"
