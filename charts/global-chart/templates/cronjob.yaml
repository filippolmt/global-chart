{{/*
  CronJobs can be defined in two places:
  1. Root level: .Values.cronJobs (standalone, optional fromDeployment for image)
  2. Inside deployments: .Values.deployments.<name>.cronJobs (inherits image, configMap, secret, SA from deployment)
*/}}

{{- $root := . }}

{{/* ====== PART 1: Root-level cronJobs ====== */}}
{{- if .Values.cronJobs }}
{{- range $name, $job := .Values.cronJobs }}
{{- if $job }}
{{- $fullname := include "global-chart.fullname" $root }}
{{- $jobFullname := printf "%s-%s" $fullname $name | trunc 63 | trimSuffix "-" }}

{{- /* Resolve image: explicit > fromDeployment > error */ -}}
{{- $jobImage := "" }}
{{- if hasKey $job "image" }}
  {{- $jobImage = include "global-chart.imageString" $job.image -}}
{{- else if $job.fromDeployment }}
  {{- $depName := $job.fromDeployment -}}
  {{- $deploy := index $root.Values.deployments $depName -}}
  {{- if not $deploy -}}
    {{- fail (printf "cronJobs.%s.fromDeployment references deployment '%s' which does not exist in .Values.deployments" $name $depName) -}}
  {{- end -}}
  {{- $jobImage = include "global-chart.imageString" $deploy.image -}}
{{- end }}
{{- $imageRef := required (printf "image is required for cronJobs.%s (set cronJobs.%s.image or cronJobs.%s.fromDeployment)" $name $name $name) $jobImage }}

{{- /* ServiceAccount - create own or use explicit name */ -}}
{{- $saCreate := and (hasKey $job "serviceAccount") (hasKey $job.serviceAccount "create") $job.serviceAccount.create }}
{{- $saName := default $jobFullname $job.serviceAccountName }}
{{- if $saCreate }}
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ $saName }}
  namespace: {{ $root.Release.Namespace | quote }}
  labels:
    {{- include "global-chart.labels" $root | nindent 4 }}
  {{- with $job.serviceAccountAnnotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
automountServiceAccountToken: {{ default true $job.automountServiceAccountToken }}
{{- end }}
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ $jobFullname }}
  labels:
    {{- include "global-chart.labels" $root | nindent 4 }}
  {{- if $job.annotations }}
  annotations:
    {{- toYaml $job.annotations | nindent 4 }}
  {{- end }}
spec:
  schedule: {{ $job.schedule | quote }}
  concurrencyPolicy: {{ default "Forbid" $job.concurrencyPolicy | quote }}
  successfulJobsHistoryLimit: {{ default 2 $job.successfulJobsHistoryLimit }}
  failedJobsHistoryLimit: {{ default 2 $job.failedJobsHistoryLimit }}
  jobTemplate:
    spec:
      template:
        spec:
          {{- with $job.imagePullSecrets }}
          imagePullSecrets:
            {{- range . }}
              {{- if kindIs "string" . }}
            - name: {{ . | quote }}
              {{- else if hasKey . "name" }}
            - name: {{ .name | quote }}
              {{- end }}
            {{- end }}
          {{- end }}
          {{- if $job.initContainers }}
          initContainers:
            {{- toYaml $job.initContainers | nindent 12 }}
          {{- end }}
          containers:
          - name: {{ $name }}
            image: {{ $imageRef | quote }}
            imagePullPolicy: {{ include "global-chart.imagePullPolicy" (dict "override" $job.imagePullPolicy "image" $job.image) | quote }}
            {{- if $job.command }}
            command:
              {{- toYaml $job.command | nindent 14 }}
            {{- end }}
            {{- if $job.args }}
            args:
              {{- toYaml $job.args | nindent 14 }}
            {{- end }}
            {{- if or $job.envFromConfigMaps $job.envFromSecrets }}
            envFrom:
              {{- range $cm := $job.envFromConfigMaps }}
              - configMapRef:
                  name: {{ $cm | quote }}
              {{- end }}
              {{- range $sec := $job.envFromSecrets }}
              - secretRef:
                  name: {{ $sec | quote }}
              {{- end }}
            {{- end }}
            {{- if $job.env }}
            env:
              {{- toYaml $job.env | nindent 14 }}
            {{- end }}
            {{- if $job.resources }}
            resources:
              {{- toYaml $job.resources | nindent 14 }}
            {{- else }}
            resources:
              requests:
                cpu: 100m
                memory: 128Mi
            {{- end }}
            {{- with $job.volumeMounts }}
            volumeMounts:
              {{- toYaml . | nindent 14 }}
            {{- end }}
          {{- with $job.volumes }}
          volumes:
            {{- range . }}
            - name: {{ .name }}
              {{- if eq .type "emptyDir" }}
              emptyDir: {}
              {{- end }}
              {{- if eq .type "configMap" }}
              configMap:
                name: {{ .configMap.name | quote }}
              {{- end }}
              {{- if eq .type "secret" }}
              secret:
                secretName: {{ default .secret.secretName .secret.name | quote }}
              {{- end }}
              {{- if eq .type "persistentVolumeClaim" }}
              persistentVolumeClaim:
                claimName: {{ default .persistentVolumeClaim.claimName .persistentVolumeClaim.name | quote }}
              {{- end }}
            {{- end }}
          {{- end }}
          serviceAccountName: {{ $saName | quote }}
          {{- with $job.nodeSelector }}
          nodeSelector:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          {{- with $job.affinity }}
          affinity:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          {{- with $job.tolerations }}
          tolerations:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          restartPolicy: {{ default "Never" $job.restartPolicy | quote }}
{{- end }}
{{- end }}
{{- end }}

{{/* ====== PART 2: Deployment-level cronJobs (inherit from deployment) ====== */}}
{{- range $deployName, $deploy := .Values.deployments }}
{{- if and $deploy $deploy.cronJobs }}
{{- range $name, $job := $deploy.cronJobs }}
{{- if $job }}

{{- /* Build cronjob fullname with deployment name for uniqueness */ -}}
{{- $jobFullname := printf "%s-%s-%s" (include "global-chart.fullname" $root) $deployName $name | trunc 63 | trimSuffix "-" }}

{{- /* Resolve image: explicit in cronjob > inherited from deployment */ -}}
{{- $jobImage := "" }}
{{- if hasKey $job "image" }}
  {{- $jobImage = include "global-chart.imageString" $job.image -}}
{{- else }}
  {{- $jobImage = include "global-chart.imageString" $deploy.image -}}
{{- end }}
{{- $imageRef := required (printf "image is required for deployments.%s.cronJobs.%s" $deployName $name) $jobImage }}

{{- /* ServiceAccount: explicit > inherited from deployment > default */ -}}
{{- $deploySA := default (dict) $deploy.serviceAccount -}}
{{- $jobSAMap := (and (hasKey $job "serviceAccount") (kindIs "map" $job.serviceAccount)) | ternary $job.serviceAccount (dict) -}}
{{- $jobSAExplicitName := coalesce $job.serviceAccountName $jobSAMap.name -}}

{{- /* Use deployment's SA name if it exists, otherwise cronjob's own SA */ -}}
{{- $deploymentSAName := "" -}}
{{- if $deploySA.create -}}
  {{- $deploymentSAName = include "global-chart.deploymentServiceAccountName" (dict "root" $root "deploymentName" $deployName "deployment" $deploy) -}}
{{- end -}}

{{- $saName := "" -}}
{{- $saCreate := false -}}
{{- if $jobSAExplicitName -}}
  {{- $saName = $jobSAExplicitName -}}
{{- else if $deploymentSAName -}}
  {{- /* Inherit from deployment's service account */ -}}
  {{- $saName = $deploymentSAName -}}
{{- else -}}
  {{- /* Create cronjob-specific SA */ -}}
  {{- $saName = $jobFullname -}}
  {{- $saCreate = true -}}
{{- end -}}

{{- /* Override saCreate if explicitly set in job */ -}}
{{- if hasKey $jobSAMap "create" -}}
  {{- $saCreate = $jobSAMap.create -}}
  {{- if $saCreate -}}
    {{- $saName = default $jobFullname $jobSAMap.name -}}
  {{- end -}}
{{- end -}}

{{- $saAutomount := true -}}
{{- if hasKey $job "automountServiceAccountToken" -}}
  {{- $saAutomount = $job.automountServiceAccountToken -}}
{{- end -}}
{{- if hasKey $jobSAMap "automount" -}}
  {{- $saAutomount = $jobSAMap.automount -}}
{{- end -}}
{{- $saAnnotations := $job.serviceAccountAnnotations -}}
{{- if hasKey $jobSAMap "annotations" -}}
  {{- $saAnnotations = $jobSAMap.annotations -}}
{{- end -}}

{{- /* Create SA only if needed (not using deployment's or explicit existing) */ -}}
{{- if $saCreate }}
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ $saName }}
  namespace: {{ $root.Release.Namespace | quote }}
  labels:
    {{- include "global-chart.labels" $root | nindent 4 }}
    app.kubernetes.io/component: {{ $deployName }}
  {{- with $saAnnotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
automountServiceAccountToken: {{ $saAutomount }}
{{- end }}

{{- /* Resolve inherited envFrom from deployment's configMap and secret */ -}}
{{- $deployFullname := include "global-chart.deploymentFullname" (dict "root" $root "deploymentName" $deployName) -}}
{{- $hasDeployConfigMap := and $deploy.configMap (gt (len $deploy.configMap) 0) -}}
{{- $hasDeploySecret := and $deploy.secret (gt (len $deploy.secret) 0) -}}
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ $jobFullname }}
  labels:
    {{- include "global-chart.labels" $root | nindent 4 }}
    app.kubernetes.io/component: {{ $deployName }}
  {{- if $job.annotations }}
  annotations:
    {{- toYaml $job.annotations | nindent 4 }}
  {{- end }}
spec:
  schedule: {{ $job.schedule | quote }}
  concurrencyPolicy: {{ default "Forbid" $job.concurrencyPolicy | quote }}
  successfulJobsHistoryLimit: {{ default 2 $job.successfulJobsHistoryLimit }}
  failedJobsHistoryLimit: {{ default 2 $job.failedJobsHistoryLimit }}
  jobTemplate:
    spec:
      template:
        spec:
          {{- /* ImagePullSecrets: explicit > inherited from deployment */ -}}
          {{- $imagePullSecrets := $job.imagePullSecrets -}}
          {{- if not $imagePullSecrets -}}
            {{- $imagePullSecrets = $deploy.imagePullSecrets -}}
          {{- end -}}
          {{- with $imagePullSecrets }}
          imagePullSecrets:
            {{- range . }}
              {{- if kindIs "string" . }}
            - name: {{ . | quote }}
              {{- else if hasKey . "name" }}
            - name: {{ .name | quote }}
              {{- end }}
            {{- end }}
          {{- end }}
          {{- if $job.initContainers }}
          initContainers:
            {{- toYaml $job.initContainers | nindent 12 }}
          {{- end }}
          containers:
          - name: {{ $name }}
            image: {{ $imageRef | quote }}
            imagePullPolicy: {{ include "global-chart.imagePullPolicy" (dict "override" $job.imagePullPolicy "image" (default $deploy.image $job.image)) | quote }}
            {{- if $job.command }}
            command:
              {{- toYaml $job.command | nindent 14 }}
            {{- end }}
            {{- if $job.args }}
            args:
              {{- toYaml $job.args | nindent 14 }}
            {{- end }}
            {{- /* EnvFrom: deployment's configMap/secret + explicit envFromConfigMaps/envFromSecrets + deployment's envFromConfigMaps/envFromSecrets */ -}}
            {{- $hasEnvFrom := or $hasDeployConfigMap $hasDeploySecret $job.envFromConfigMaps $job.envFromSecrets $deploy.envFromConfigMaps $deploy.envFromSecrets -}}
            {{- if $hasEnvFrom }}
            envFrom:
              {{- /* Deployment's generated ConfigMap */ -}}
              {{- if $hasDeployConfigMap }}
              - configMapRef:
                  name: {{ $deployFullname | quote }}
              {{- end }}
              {{- /* Deployment's generated Secret */ -}}
              {{- if $hasDeploySecret }}
              - secretRef:
                  name: {{ $deployFullname | quote }}
              {{- end }}
              {{- /* Deployment's external ConfigMaps */ -}}
              {{- range $cm := $deploy.envFromConfigMaps }}
              - configMapRef:
                  name: {{ $cm | quote }}
              {{- end }}
              {{- /* Deployment's external Secrets */ -}}
              {{- range $sec := $deploy.envFromSecrets }}
              - secretRef:
                  name: {{ $sec | quote }}
              {{- end }}
              {{- /* CronJob's explicit external ConfigMaps */ -}}
              {{- range $cm := $job.envFromConfigMaps }}
              - configMapRef:
                  name: {{ $cm | quote }}
              {{- end }}
              {{- /* CronJob's explicit external Secrets */ -}}
              {{- range $sec := $job.envFromSecrets }}
              - secretRef:
                  name: {{ $sec | quote }}
              {{- end }}
            {{- end }}
            {{- /* Env: deployment's additionalEnvs + cronjob's env */ -}}
            {{- $envVars := list -}}
            {{- if $deploy.additionalEnvs -}}
              {{- $envVars = $deploy.additionalEnvs -}}
            {{- end -}}
            {{- if $job.env -}}
              {{- $envVars = concat $envVars $job.env -}}
            {{- end -}}
            {{- if $envVars }}
            env:
              {{- toYaml $envVars | nindent 14 }}
            {{- end }}
            {{- if $job.resources }}
            resources:
              {{- toYaml $job.resources | nindent 14 }}
            {{- else }}
            resources:
              requests:
                cpu: 100m
                memory: 128Mi
            {{- end }}
            {{- with $job.volumeMounts }}
            volumeMounts:
              {{- toYaml . | nindent 14 }}
            {{- end }}
          {{- with $job.volumes }}
          volumes:
            {{- range . }}
            - name: {{ .name }}
              {{- if eq .type "emptyDir" }}
              emptyDir: {}
              {{- end }}
              {{- if eq .type "configMap" }}
              configMap:
                name: {{ .configMap.name | quote }}
              {{- end }}
              {{- if eq .type "secret" }}
              secret:
                secretName: {{ default .secret.secretName .secret.name | quote }}
              {{- end }}
              {{- if eq .type "persistentVolumeClaim" }}
              persistentVolumeClaim:
                claimName: {{ default .persistentVolumeClaim.claimName .persistentVolumeClaim.name | quote }}
              {{- end }}
            {{- end }}
          {{- end }}
          serviceAccountName: {{ $saName | quote }}
          {{- /* NodeSelector: explicit > inherited from deployment */ -}}
          {{- $nodeSelector := $job.nodeSelector -}}
          {{- if not $nodeSelector -}}
            {{- $nodeSelector = $deploy.nodeSelector -}}
          {{- end -}}
          {{- with $nodeSelector }}
          nodeSelector:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          {{- /* Affinity: explicit > inherited from deployment */ -}}
          {{- $affinity := $job.affinity -}}
          {{- if not $affinity -}}
            {{- $affinity = $deploy.affinity -}}
          {{- end -}}
          {{- with $affinity }}
          affinity:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          {{- /* Tolerations: explicit > inherited from deployment */ -}}
          {{- $tolerations := $job.tolerations -}}
          {{- if not $tolerations -}}
            {{- $tolerations = $deploy.tolerations -}}
          {{- end -}}
          {{- with $tolerations }}
          tolerations:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          restartPolicy: {{ default "Never" $job.restartPolicy | quote }}
{{ end }}
{{- end }}
{{- end }}
{{- end }}
