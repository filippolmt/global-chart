{{- $root := . }}
{{- $fullname := include "global-chart.fullname" $root }}
{{- if $root.Values.rbacs.roles }}
{{- range $index, $role := $root.Values.rbacs.roles }}
{{- $defaultRoleName := printf "%s-role-%d" $fullname $index | trunc 63 | trimSuffix "-" }}
{{- $roleName := default $defaultRoleName $role.name }}
{{- $sa := $role.serviceAccount }}
{{- $saName := "" }}
{{- $saCreate := false }}
{{- if $sa }}
{{- $defaultSaName := printf "%s-sa" $roleName | trunc 63 | trimSuffix "-" }}
{{- $saName = default $defaultSaName $sa.name }}
{{- $saCreate = true }}
{{- if hasKey $sa "create" }}
  {{- $saCreate = $sa.create }}
{{- end }}
{{- end }}
{{- if and $sa $saCreate }}
apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ $saName }}
  namespace: {{ $root.Release.Namespace | quote }}
  labels:
    {{- include "global-chart.labels" $root | nindent 4 }}
  {{- with $sa.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
{{- if hasKey $sa "automount" }}
automountServiceAccountToken: {{ $sa.automount }}
{{- end }}
---
{{- end }}
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: {{ $roleName }}
  namespace: {{ $root.Release.Namespace | quote }}
  labels:
    {{- include "global-chart.labels" $root | nindent 4 }}
rules:
{{- with $role.rules }}
{{ toYaml . | indent 2 }}
{{- else }}
  []
{{- end }}
---
{{- if $saName }}
{{- $bindingBase := $roleName }}
{{- if hasSuffix "-role" $roleName }}
  {{- $bindingBase = trimSuffix "-role" $roleName }}
{{- end }}
{{- $roleBindingName := printf "%s-rolebinding" $bindingBase | trunc 63 | trimSuffix "-" }}
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: {{ $roleBindingName }}
  namespace: {{ $root.Release.Namespace | quote }}
  labels:
    {{- include "global-chart.labels" $root | nindent 4 }}
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: {{ $roleName }}
subjects:
  - kind: ServiceAccount
    name: {{ $saName }}
    namespace: {{ $root.Release.Namespace | quote }}
---
{{- end }}
{{- end }}
{{- end }}
